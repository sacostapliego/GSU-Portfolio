<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - Santa's Adaptive Christmas Fifteen Puzzle</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .results-wrapper { max-width: 960px; margin: 0 auto; padding: 1.5rem; text-align: center; }
        .stats-list { list-style: none; padding: 0; margin: 1rem auto; display: inline-flex; gap: 1.5rem; font-size: 1.05rem; }
        .story-card { max-width: 820px; margin: 1.25rem auto; padding: 1.25rem 1.5rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        .story-card h3 { margin: 0 0 0.25rem 0; font-size: 1.25rem; }
        .story-card h4 { margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #ffd54f; }
        #story-segment { font-size: 1.07rem; line-height: 1.6; margin-bottom: 0.75rem; }
        #solved-image { width: 340px; height: 340px; margin: 1.5em auto; border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.35); background: #222 center/cover no-repeat; }
    </style>
</head>
<body>
<!-- Background Christmas Music (Loops Continuously) -->
<audio id="bg-music" loop>
    <source src="assets/christmas.mp3" type="audio/mpeg">
    <source src="assets/christmas.wav" type="audio/wav">
    <source src="assets/christmas.ogg" type="audio/ogg">
</audio>

<!-- Music Control Button and Volume Slider -->
<div class="music-controls">
    <button id="music-toggle" class="music-btn" title="Toggle Music">ğŸ”Š</button>
    <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="15" title="Volume Control">
</div>
<header>
    <div class="snowfall"></div>
    <h1>ğŸ… Santa's Adaptive Christmas Fifteen Puzzle ğŸ„</h1>
    <nav>
        <a href="index_demo.html">ğŸ  Home</a> |
        <a href="game_demo.html">ğŸ® Play</a>
        <button id="theme-toggle" style="float:right;margin-left:2em;">ğŸŒ™ Switch Theme</button>
    </nav>
</header>
<main class="results-wrapper">
    <div class="celebration">ğŸ‰ ğŸŠ ğŸ‰</div>
    <h2>ğŸ† Game Results ğŸ†</h2>
    <p>ğŸ„ Great job! Here's how you did: ğŸ„</p>
    <ul class="stats-list">
        <li>â±ï¸ Time: <span id="result-time">00:00</span></li>
        <li>ğŸ“Š Moves: <span id="result-moves">0</span></li>
        <li>â­ Difficulty: <span id="result-difficulty">Normal</span></li>
    </ul>
    <div id="story-mode" class="story-card">
        <h3>ğŸ“– Santa's Workshop Story ğŸ“–</h3>
        <h4 id="story-title"></h4>
        <div id="story-segment">Loading story...</div>
    </div>
    <div id="solved-image"></div>
    <button id="next-stage-btn" class="start-btn" style="margin-top: 1.5em;">â¡ï¸ Next Stage</button>
    <button id="play-again-btn" class="start-btn" style="margin-top: 1.5em;">ğŸ® Play Again ğŸ®</button>
    <div class="decoration">ğŸ ğŸ… ğŸ¦Œ ğŸ… ğŸ</div>
</main>
<footer>
    <p>&copy; 2025 Santa's Workshop. All rights reserved.</p>
</footer>
<script>
// Theme toggle logic and Background Music Control
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('theme-toggle');
    const bgMusic = document.getElementById('bg-music');
    const musicToggle = document.getElementById('music-toggle');
    const volumeSlider = document.getElementById('volume-slider');
    
    // Theme toggle
    function setTheme(theme) {
        document.body.classList.toggle('theme-dark', theme === 'dark');
        localStorage.setItem('theme', theme);
    }
    const saved = localStorage.getItem('theme') || 'light';
    setTheme(saved);
    btn.textContent = saved === 'dark' ? 'â˜€ï¸ Light Theme' : 'ğŸŒ™ Switch Theme';
    btn.onclick = function() {
        const newTheme = document.body.classList.contains('theme-dark') ? 'light' : 'dark';
        setTheme(newTheme);
        btn.textContent = newTheme === 'dark' ? 'â˜€ï¸ Light Theme' : 'ğŸŒ™ Switch Theme';
    };
    
    // Background Music Control
    bgMusic.volume = 0.15; // Set volume to 15% (quieter background music)
    bgMusic.play().catch(() => {
        console.log('Autoplay prevented. Music will start on user click.');
    });
    
    // Toggle music on/off
    musicToggle.onclick = function() {
        if (bgMusic.paused) {
            bgMusic.play();
            musicToggle.textContent = 'ğŸ”Š';
        } else {
            bgMusic.pause();
            musicToggle.textContent = 'ğŸ”‡';
        }
    };
    
    // Volume slider control
    volumeSlider.oninput = function() {
        bgMusic.volume = this.value / 100;
        localStorage.setItem('musicVolume', this.value);
    };
    
    // Load user's music volume preference
    const savedVolume = localStorage.getItem('musicVolume');
    if (savedVolume) {
        volumeSlider.value = savedVolume;
        bgMusic.volume = savedVolume / 100;
    }
    
    // Load music play/pause preference
    if (localStorage.getItem('musicEnabled') === 'false') {
        bgMusic.pause();
        musicToggle.textContent = 'ğŸ”‡';
    }
    
    // Save music state when toggled
    musicToggle.addEventListener('click', function() {
        localStorage.setItem('musicEnabled', !bgMusic.paused);
    });

    // Story mode with stage-aware segments and last result display
    const STAGES = {
        1: {
            title: "Stage 1: Welcome to Santa's Workshop",
            segments: [
               "Santa's workshop is unusually quiet. The elves are gathered around a long worktable, staring at a half-finished display of magical tiles. Santa explains that these tiles power the workshop's systems, but something has gone wrong. The pieces are scattered, and without restoring order, production cannot begin. This first task is simple, meant to test your understanding of how the workshop works. Once the tiles are restored, the workshop lights flicker back on, signaling that the preparations for Christmas can finally begin."
            ]
        },
        2: {
            title: "Stage 2: The Toy Assembly Line Breakdown",
            segments: [
                 "With the workshop running again, the elves rush to the toy assembly line. Suddenly, the conveyor system freezes. The control tiles that guide toy construction have shifted out of place. Santa asks you to fix the layout before valuable time is lost. The elves warn that the tiles are trickier this time, and careless moves could slow everything down. As you restore the correct order, the machines hum back to life and toys begin moving down the line once more."
            ]
        },
        3: {
            title: "Stage 3: Sorting the Enchanted Gift Tiles",
            segments: [
                "As Christmas Eve draws closer, the gifts themselves begin to glow with enchantment. These magical tiles determine which gifts go to which destinations around the world. Unfortunately, the enchantments interfere with each other, scrambling the tile order. Santa needs precision now. The tiles resist being moved, and only careful planning will restore harmony. When the puzzle is solved, the glow stabilizes, and the gifts align perfectly, ready for delivery."
            ]
        },
        4: {
            title: "Stage 4: Training the Elves Under Pressure",
            segments: [
                 "The elves must now be trained to handle last-minute changes. Santa rearranges the workshop layout to simulate chaos, intentionally making the puzzle more complex. Time is short, and mistakes matter. The elves watch closely as you restore order, learning from every move. Solving this puzzle proves that you can think clearly under pressure. When the tiles click into place, the elves cheer, confident they can handle whatever Christmas throws at them."
            ]
        },
        5: {
            title: "Stage 5: Final Preparations for Christmas Eve",
            segments: [
                 "It is the final night before Christmas. Snow falls outside as Santa prepares the sleigh. The most important control tiles of all are scattered across the table. This puzzle represents the entire workshop working together. Every move must be deliberate. When the final tile slides into place, the workshop glows brighter than ever. Santa smiles, knowing everything is ready. Thanks to your help, Christmas can begin."
            ]
        }
    };

    const lastResult = JSON.parse(localStorage.getItem('lastResult') || '{}');
    const stageForStory = Math.max(1, Math.min(5, parseInt(lastResult.stage || localStorage.getItem('unlockedStage') || '1', 10)));
    const story = STAGES[stageForStory];
    document.getElementById('story-title').textContent = story.title;

    // Fill result stats and preview image
    document.getElementById('result-time').textContent = lastResult.time !== undefined ? formatTime(lastResult.time) : '00:00';
    document.getElementById('result-moves').textContent = lastResult.moves !== undefined ? lastResult.moves : '0';
    document.getElementById('result-difficulty').textContent = lastResult.difficulty || 'Normal';
    if (lastResult.image) {
        document.getElementById('solved-image').style.backgroundImage = `url('${lastResult.image}')`;
    }

    // Display all story segments at once
    document.getElementById('story-segment').textContent = story.segments.join('\n\n');

    function formatTime(t) {
        const m = String(Math.floor(t / 60)).padStart(2, '0');
        const s = String(t % 60).padStart(2, '0');
        return `${m}:${s}`;
    }

    document.getElementById('next-stage-btn').onclick = function() {
        const next = Math.min(5, (stageForStory || 1) + 1);
        localStorage.setItem('unlockedStage', String(next));
        localStorage.setItem('currentStage', String(next));
        location.href = 'game_demo.html';
    };
    
    document.getElementById('play-again-btn').onclick = function() {
        localStorage.setItem('currentStage', String(stageForStory));
        location.href = 'game_demo.html';
    };
});
</script>
</body>
</html>
